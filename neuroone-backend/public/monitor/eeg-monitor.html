<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitor Web</title>
  <style>
    :root{
      --bg:#0a0f1e;
      --panel:#0f1628;
      --line:#1b2747;
      --text:#e6eeff;
      --muted:#9fb0ffaa;
    }
	
	/* Tablet landscape e desktop pequeno (768px - 1024px) */
	@media (max-width: 1024px) and (min-width: 768px) {
		.card {
			width: 95vw !important;
			height: auto !important;
			min-height: 60vh !important;
			max-height: 85vh !important;
		}
		.left {
			padding: 20px !important;
		}
		.right {
			padding: 20px !important;
		}
		.status-light {
			--size: 160px !important;
		}
		#nomeInput {
			font-size: 14px !important;
			padding: 12px 16px !important;
		}
		.mock-gui {
			width: 200px !important;
		}
		.mock-gui .bar {
			height: 48px !important;
			font-size: 14px !important;
		}
		#infoAluno h1 {
			font-size: 24px !important;
		}
	}

	/* Mobile e tablet portrait (max-width: 767px) */
	@media (max-width: 767px) {
		.app {
			padding: 12px !important;
		}
		.card {
			flex-direction: column !important;
			width: 96vw !important;
			height: auto !important;
			min-height: 70vh !important;
			max-height: 90vh !important;
		}
		.left {
			flex: 0 0 auto !important;
			padding: 16px !important;
		}
		.right {
			flex: 1 1 auto !important;
			padding: 16px !important;
		}
		.status-wrapper {
			margin-top: 10px !important;
		}
		.status-light {
			--size: 120px !important;
		}
		.status-label {
			font-size: 12px !important;
		}
		#formulario {
			flex-direction: column !important;
			padding-top: 10px !important;
			gap: 10px !important;
		}
		#formulario input {
			width: 100% !important;
			margin-bottom: 0 !important;
			font-size: 14px !important;
		}
		.mock-gui {
			width: 100% !important;
		}
		.mock-gui .bar {
			height: 44px !important;
			font-size: 13px !important;
		}
		#infoAluno h1 {
			font-size: 18px !important;
		}
	}
	
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow:hidden;
    }
    body::before{content:""; position:fixed; inset:0; pointer-events:none; opacity:.25;
      background:
        linear-gradient(transparent 0 98%, #1b264770 98% 100%),
        linear-gradient(90deg, transparent 0 98%, #1b264770 98% 100%);
      background-size:36px 36px,36px 36px;
    }

    /* CARD PRINCIPAL */
    .app{display:flex; align-items:center; justify-content:center; min-height:100vh; padding:24px;}
    .card{
      position:relative;
      width:min(1120px, 92vw);
      height:auto;
      min-height:400px;
      max-height:85vh;
      background: linear-gradient(180deg, #0f1628, #0b1325);
      border:1px solid var(--line); border-radius:22px;
      box-shadow: 0 18px 50px #0008, inset 0 1px 0 #2a3966aa;
      overflow:hidden; display:flex;
    }
    .left{flex: 0 0 30%; padding:28px; display:flex; flex-direction:column; justify-content:flex-start;}
    .right{flex: 0 0 70%; padding:28px; display:flex; align-items:center; justify-content:center; position:relative;}

    /* STATUS LIGHT (canto superior esquerdo) */
    .status-wrapper{
      margin-top:40px; display:flex; flex-direction:column; align-items:center; user-select:none;
    }
    .status-light{
      --size: 200px;
      width:var(--size); height:var(--size); border-radius:50%; cursor:pointer; position:relative;
      background:
        radial-gradient(40% 40% at 30% 28%, #ffffffaa 0%, #ffffff33 22%, #0000 45%),
        radial-gradient(65% 65% at 50% 50%, currentColor 0%, #0000 70%);
      box-shadow: 0 0 50px currentColor, inset 0 0 30px rgba(0,0,0,.65);
      transition: transform .15s ease;
    }
    .status-light:active{ transform:scale(.97) }
    .status-light::after{
      content:""; position:absolute; inset:-28px; border-radius:inherit;
      background:currentColor; filter:blur(36px); opacity:.75;
    }
    .status-light[data-state="green"]{ color:#00ff88 }
    .status-light[data-state="red"]{ color:#ff2d55 }
    .status-light[data-state="gray"]{ color:#AAAAAA }
    .status-label{
      margin-top:12px; font-size:14px; letter-spacing:.12em; font-weight:700; color:var(--muted);
    }

    /* PAINEL DIREITO - INPUT + BOT√ÉO + NOME */
    .infoAluno{
      width:100%; position:relative; min-height:200px; height:100%; border-radius:14px; border:1px solid #223055; overflow:hidden; background:#0b1223;
      display:flex; align-items:center; justify-content:center; padding:20px;
    }
    #formulario{
	  display:flex;
	  flex-direction:row;
      margin-bottom:20px;
	  gap:20px;
    }
    #nomeInput{
      width:80%; max-width:360px; padding:14px 18px;
      font-size:16px; background:#0f1729; border:1px solid #2a3966;
      border-radius:12px; color:#e6eeff; outline:none;
      transition:border .2s;
    }
    #nomeInput:focus{ border-color:#00ff88; }

    .mock-gui{
      display:inline-block; width:240px; border-radius:14px; border:1px solid #2a3966;
      background:#0c1430; box-shadow:0 10px 30px #000a, inset 0 1px 0 #2a3966;
      overflow:hidden; cursor:pointer; transition:all .3s;
    }
    .mock-gui:hover{
      box-shadow:0 10px 30px #2ded47, inset 0 1px 0 #2ded47;
      transform:translateY(-2px);
    }
    .mock-gui .bar{
      height:56px; background:linear-gradient(180deg,#121a36,#0b1124);
      border-bottom:1px solid #223055; display:flex; align-items:center; justify-content:center;
      color:#9fb0ff; font-size:15px; letter-spacing:.12em; font-weight:600;
    }

    #infoAluno h1{
      font-size:28px; color:#c9d5ff; margin:0;
    }
    #nomeAluno{ color:#00ff88; font-weight:700; }
	
	/*Estilo Modal*/
	.modal {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.5);
		justify-content: center;
		align-items: center;
		z-index: 1000;
		overflow:hidden;
	}
	.modal-content {		
		text-align:center;
		background-color: #fff;
		border-radius: 10px;
		padding: 20px;
		width: 90%;
		max-width: 600px;
		max-height: 12vh;
		overflow-y: auto;
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);	
		overflow:hidden;
	}
	.modal-content h1 {
		font-size: 1.5em;
		margin: 0 0 15px;
		text-align: center;
	}
	.modal-content button {
		font-family: 'Bowlby One', Arial, sans-serif;
		padding: 8px 16px;
		font-size: 18px;
		font-weight:400;
		cursor: pointer;
		background-color: #007bff;
		color: white;
		border: none;
		border-radius: 5px;
		margin: 5px;
	}
	.modal-content button:hover {
		background-color: #0056b3;
	}
	#status {
		margin: 15px 0;
		padding: 10px;
		background-color: #f8f9fa;
		border-radius: 5px;
		min-height: 80px;
		font-size: 14px;
	}
	#uuidList {
		margin: 15px 0;
		padding: 10px;
		background-color: #f8f9fa;
		border-radius: 5px;
		max-height: 200px;
		overflow-y: auto;
		font-size: 14px;
	}
	#dataOutput {
		margin: 15px 0;
		padding: 10px;
		background-color: #f8f9fa;
		border-radius: 5px;
		min-height: 150px;
		max-height: 300px;
		overflow-y: auto;
		font-family: monospace;
		white-space: pre;
		font-size: 12px;
	}
	select {
		width: 100%;
		padding: 8px;
		margin: 10px 0;
		border-radius: 5px;
		font-size: 14px;
	}
	.toggle-btn {
		padding: 10px 20px;
		font-size: 16px;
		cursor: pointer;
		background-color: #28a745;
		color: white;
		border: none;
		border-radius: 5px;
	}
	.toggle-btn:hover {
		background-color: #218838;
	}
	.close-btn {
		float: right;
		font-size: 20px;
		cursor: pointer;
		color: #333;
	}
  </style>
</head>
<body>
  <div class="modal" id="bluetoothModal">
		<div class="modal-content">
			<span class="close-btn" onclick="toggleModal()">&times;</span>
			<h1>Conectar via Bluetooth</h1>
			<button onclick="connectAndDiscover()">Conectar</button>
			<div id="status" style="display:none">Status: Desconectado</div>
			<div id="uuidList" style="display:none">Servi√ßos e Chars</div>
			<label style="display:none">Escolha Char</label>
			<select id="charSelect" onchange="selectCharacteristic()" style="display:none">
				<option value="">-- Selecione --</option>
			</select>
			<button onclick="connectWebSocket()" style="display:none">1 - Comando Iniciar</button>
			<button onclick="startStream()" style="display:none">2 - Iniciar Stream</button>
			<button onclick="readCharacteristic()" style="display:none">2 - Ler Dados</button>            
			<button onclick="disconnectBluetooth()" style="display:none" id="disconnectBtn">Desconectar</button>            
			<div id="dataOutput">Dados</div>
		</div>
	</div>
  <main class="app">
    <section class="card">
      <!-- LADO ESQUERDO - STATUS LIGHT -->
      <div class="left">
        <div class="status-wrapper" title="Clique para alternar">
          <div class="status-light" id="statusLight" data-state="gray"></div>
          <div class="status-label" id="statusLabel">AGUARDANDO</div>
        </div>
      </div>

      <!-- LADO DIREITO - FORMUL√ÅRIO E BOT√ÉO -->
      <div class="right">
        <div class="infoAluno">
          <!-- CAMPO DE TEXTO E BOT√ÉO (ser√£o escondidos ap√≥s clicar) -->
          <div id="formulario">
            <input type="text" id="nomeInput" placeholder="Nome do Aluno" autocomplete="off" />
            <div class="mock-gui" id="botao">
              <div class="bar">INICIAR</div>
            </div>
          </div>

          <!-- NOME DO ALUNO (aparece ap√≥s iniciar) -->
          <div id="infoAluno" style="display:none;">
            <h1>Aluno: <span id="nomeAluno"></span></h1>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Socket.IO Client (servido localmente) -->
  <script src="/monitor/socket.io.min.js"></script>

  <script>
    // ========== DEBUG LOGGER ==========
    // Para ativar logs, execute no console: localStorage.setItem('DEBUG_MODE', 'true')
    // Para desativar logs: localStorage.removeItem('DEBUG_MODE')
    const DEBUG_MODE = localStorage.getItem('DEBUG_MODE') === 'true';
    const debugLog = {
      log: (...args) => DEBUG_MODE && console.log(...args),
      info: (...args) => DEBUG_MODE && console.info(...args),
      warn: (...args) => console.warn(...args), // Warnings sempre aparecem
      error: (...args) => console.error(...args), // Errors sempre aparecem
      success: (...args) => DEBUG_MODE && console.log(...args),
    };

    const light = document.getElementById('statusLight');
    const label = document.getElementById('statusLabel');
    const botao = document.getElementById('botao');
    const formulario = document.getElementById('formulario');
    const infoAluno = document.getElementById('infoAluno');
    const nomeInput = document.getElementById('nomeInput');
    const nomeAlunoSpan = document.getElementById('nomeAluno');

	const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
	
	let device = null;
	let server = null;
	let characteristics = [];
	let att = 0;
	let med = 0;
	const statusDiv = document.getElementById('status');
	const uuidListDiv = document.getElementById('uuidList');
	const dataOutputDiv = document.getElementById('dataOutput');
	const charSelect = document.getElementById('charSelect');
	const modal = document.getElementById('bluetoothModal');
	const disconnectBtn = document.getElementById('disconnectBtn');
	let selectedChar = null;
	let codigo = null;
	let ondas = {					
					Att: 0,
					Med: 0,
					Delta: 0,		
					Theta: 0,
					LowAlpha: 0,
					HighAlpha: 0,
					LowBeta: 0,
					HighBeta: 0,
					LowGamma: 0,
					MiddleGamma: 0
				};
	
	// Socket.IO - Integra√ß√£o com backend
	let socket = null;
	let sessionId = null;
	let studentId = null;
	let sendInterval = null;
	let lastEEGSendTime = 0;
	const EEG_SEND_INTERVAL = 200; // ms (5 Hz = 300 requests/min, matches backend rate limit of 300/60s)

    // Inicia no estado "aguardando"
    light.setAttribute('data-state', 'gray');
    label.textContent = 'AGUARDANDO';

    botao.addEventListener('click', () => {
      const nome = nomeInput.value.trim();
      if (nome === '') {
        nomeInput.style.borderColor = '#ff2d55';
        nomeInput.placeholder = 'Digite o nome antes de iniciar';
        return;
      }

	  // Extrair sessionId e studentId da URL
	  const params = new URLSearchParams(window.location.search);
	  sessionId = params.get('sessionId');
	  studentId = params.get('studentId');

	  if (!sessionId || !studentId) {
		console.error('‚ùå sessionId ou studentId n√£o fornecidos na URL');
		alert('Erro: URL inv√°lida. Abra o monitor atrav√©s do dashboard do aluno.');
		return;
	  }

	  // Inicializar Socket.IO para enviar dados ao backend
	  initializeSocketIO(nome);

	  // Conectar Bluetooth
	  connectAndDiscover();

      // Esconde input + bot√£o
      formulario.style.display = 'None';
      // Mostra nome do aluno
      nomeAlunoSpan.textContent = nome;
      infoAluno.style.display = 'Block';

      // Muda luz para verde e texto para ONLINE
      light.setAttribute('data-state', 'green');
      label.textContent = 'ATEN√á√ÉO';
      label.style.color = '#7dffcf';
    });

    // Permite pressionar Enter no input
    nomeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') botao.click();
    });
	
	
	function updateStatus(message) {		
		debugLog.log(message);
	}

	function appendData(data) {
		const timestamp = new Date().toLocaleTimeString();
		const dataLine = `[${timestamp}] ${data}\n`;
		dataOutputDiv.textContent += dataLine;
		dataOutputDiv.scrollTop = dataOutputDiv.scrollHeight;
	}

	function displayUuids(services) {
		let html = '<h3>Servi√ßos Encontrados:</h3>';
		charSelect.innerHTML = '<option value="">-- Selecione --</option>';
		characteristics = [];
		services.forEach(async (service) => {
			html += `<p><strong>Servi√ßo: ${service.uuid}</strong></p><ul>`;
			try {
				const chars = await service.getCharacteristics();
				debugLog.log(`Chars no servi√ßo ${service.uuid}:`, chars);
				if (chars.length === 0) {
					html += `<li>Sem chars. Tente outro servi√ßo.</li>`;
				}
				chars.forEach((char) => {
					const props = getProperties(char.properties);
					html += `<li>Char: ${char.uuid} (Props: ${props})</li>`;				
					const charInfo = { char, service };
					characteristics.push(charInfo);
					if(service.uuid == '0000ffe0-0000-1000-8000-00805f9b34fb' && !selectedChar){
						selectedChar = characteristics[characteristics.length - 1];
						updateStatus(`Char selecionada: ${selectedChar.char.uuid}. Prov√°vel stream ThinkGear.`);
						sendStartCommand();
						setTimeout(() => {
							startStream();
							// Socket.IO j√° est√° conectado via initializeSocketIO() - n√£o precisa reconectar
						}, 1000);
					}
					const option = document.createElement('option');
					option.value = characteristics.length - 1;
					option.textContent = `${service.uuid.substring(0,8)}... > ${char.uuid.substring(0,8)}... (${props})`;
					charSelect.appendChild(option);
				});
			} catch (error) {
				html += `<li>Erro: ${error.message}</li>`;
			}
			html += '</ul>';
		});
		uuidListDiv.innerHTML = html;
		updateStatus(`Achados ${services.length} servi√ßos. Escolha char com NOTIFY pra stream EEG (MindWave serial).`);
	}

	function getProperties(props) {
		const propMap = { 0x02: 'READ', 0x04: 'WRITE_NO_RESPONSE', 0x08: 'WRITE', 0x10: 'NOTIFY', 0x20: 'INDICATE', 0x01: 'BROADCAST' };
		return Object.keys(propMap).filter(key => (props & parseInt(key)) !== 0).map(key => propMap[key]).join(', ') || 'NENHUMA';
	}

	async function selectCharacteristic() {
		const index = parseInt(charSelect.value);
		if (index >= 0 && characteristics[index]) {
			selectedChar = characteristics[index];
			updateStatus(`Char selecionada: ${selectedChar.char.uuid}. Prov√°vel stream ThinkGear.`);
		}
	}

	async function readCharacteristic() {
		if (!selectedChar) return updateStatus('Selecione uma char!');
		try {
			if (selectedChar.char.properties.read) {
				const value = await selectedChar.char.readValue();
				const parsed = parseThinkGearPacket(value.buffer);
				appendData(parsed);
			} else {
				updateStatus('Char sem READ. Use stream ou WRITE pra trigger.');
			}
		} catch (error) {
			updateStatus(`Erro leitura: ${error.message}`);
		}
	}

	async function startStream() {	
		if (!selectedChar) return updateStatus('Selecione uma char!');
		try {
			if (selectedChar.char.properties.notify || selectedChar.char.properties.indicate) {
				await selectedChar.char.startNotifications();
				selectedChar.char.addEventListener('characteristicvaluechanged', handleThinkGearStream);
				updateStatus('Stream ThinkGear ativo! Foco pra attention, relax pra alpha waves.');				
			} else {
				updateStatus('Char sem NOTIFY. Tente serial port service (0x1101).');
			}
		} catch (error) {
			updateStatus(`Erro stream: ${error.message}. Pareie como serial antes.`);
		}
	}

	async function sendStartCommand() {
		if (!selectedChar) return updateStatus('Selecione uma char!');
		try {
			if (selectedChar.char.properties.write || selectedChar.char.properties.write_no_response) {
				const command = new Uint8Array([0x03]);
				await selectedChar.char.writeValue(command);
				updateStatus('Comando 0x03 enviado. Tente stream agora.');
			} else {
				updateStatus('Char sem WRITE. Escolha outra com WRITE.');
			}
		} catch (error) {
			updateStatus(`Erro ao enviar comando: ${error.message}`);
		}
	}
	

	/**
	 * Inicializa conex√£o Socket.IO com o backend
	 */
	function initializeSocketIO(studentName) {
		debugLog.log('üìä [MONITOR] Inicializando Socket.IO...');
		debugLog.log('üìã [MONITOR] Par√¢metros:', { sessionId, studentId, studentName });

		// Obter token de autentica√ß√£o: prioridade URL (cross-origin), fallback localStorage
		const params = new URLSearchParams(window.location.search);
		let authToken = params.get('token'); // Tentar da URL primeiro
		let tokenSource = 'URL';

		if (!authToken) {
			// Fallback: tentar localStorage (mesma origem)
			authToken = localStorage.getItem('authToken');
			tokenSource = 'localStorage';
		}

		debugLog.log('üîë [MONITOR] Token encontrado:', authToken ? `SIM (origem: ${tokenSource}, comprimento: ${authToken.length})` : 'N√ÉO');

		if (!authToken) {
			console.error('‚ùå [MONITOR] Token de autentica√ß√£o n√£o encontrado na URL nem no localStorage');
			console.error('   URL atual:', window.location.href);
			console.error('   localStorage.authToken:', localStorage.getItem('authToken'));
			return;
		}

		// Conectar ao backend
		const API_URL = window.location.hostname === 'localhost'
			? 'http://localhost:3001'
			: 'https://neurogame-7av9.onrender.com';

		debugLog.log('üîå [MONITOR] Conectando ao backend:', API_URL);

		socket = io(API_URL, {
			auth: { token: authToken },
			transports: ['websocket', 'polling'],
			reconnection: true,
			reconnectionAttempts: 5,
		});

		// Eventos Socket.IO
		socket.on('connect', () => {
			debugLog.log('‚úÖ [MONITOR] Socket.IO conectado!', socket.id);
			debugLog.log('üì§ [MONITOR] Enviando student:join com:', { sessionId, studentId, studentName });

			// Entrar na sess√£o como estudante
			socket.emit('student:join', {
				sessionId: sessionId,
				studentId: studentId,
				studentName: studentName,
			});

			// Iniciar envio autom√°tico de dados EEG
			if (sendInterval) clearInterval(sendInterval);

			sendInterval = setInterval(() => {
				sendEEGData();
			}, EEG_SEND_INTERVAL);

			debugLog.log('‚è±Ô∏è [MONITOR] Envio autom√°tico iniciado (intervalo:', EEG_SEND_INTERVAL, 'ms)');
		});

		socket.on('student:joined', (data) => {
			debugLog.log('‚úÖ [MONITOR] Entrou na sess√£o:', data);
		});

		socket.on('disconnect', (reason) => {
			debugLog.log('üîå [MONITOR] Socket.IO desconectado:', reason);

			// Parar envio autom√°tico
			if (sendInterval) {
				clearInterval(sendInterval);
				sendInterval = null;
				debugLog.log('‚è±Ô∏è [MONITOR] Envio autom√°tico parado');
			}
		});

		socket.on('error', (error) => {
			console.error('‚ùå [MONITOR] Erro Socket.IO:', {
				message: error?.message || 'Unknown error',
				type: error?.constructor?.name,
				stack: error?.stack,
				full: error
			});
		});

		socket.on('eeg:received', (data) => {
			debugLog.log('üìä [MONITOR] Dados EEG recebidos pelo backend:', data.timestamp);
		});

		socket.on('connect_error', (error) => {
			console.error('‚ùå [MONITOR] Erro de conex√£o Socket.IO:', error.message);
		});
	}

	/**
	 * Envia dados EEG para o backend via Socket.IO
	 */
	function sendEEGData() {
		if (!socket || !socket.connected) {
			// Log apenas primeira vez para evitar spam
			if (!sendEEGData.loggedNotConnected) {
				console.warn('‚ö†Ô∏è [MONITOR] sendEEGData chamado mas socket n√£o conectado');
				sendEEGData.loggedNotConnected = true;
			}
			return; // Socket n√£o conectado
		}

		// Throttling
		const now = Date.now();
		if (now - lastEEGSendTime < EEG_SEND_INTERVAL) {
			return;
		}
		lastEEGSendTime = now;

		// ‚ö†Ô∏è VALIDA√á√ÉO: N√£o enviar dados se ainda n√£o recebemos valores eSense do MindWave
		if (ondas.Att === 0 && ondas.Med === 0) {
			if (!sendEEGData.warnedNoData) {
				console.warn('‚ö†Ô∏è [MONITOR] MindWave n√£o est√° transmitindo dados eSense (Attention/Meditation)');
				console.warn('   Aguardando pacotes ThinkGear com c√≥digos 0x04 e 0x05...');
				console.warn('   Valores atuais:', {
					Att: ondas.Att,
					Med: ondas.Med,
					Delta: ondas.Delta,
					Theta: ondas.Theta
				});
				sendEEGData.warnedNoData = true;
			}
			return; // N√£o enviar dados inv√°lidos
		}

		// Log peri√≥dico (a cada 5 segundos) para n√£o sobrecarregar console
		if (!sendEEGData.lastLogTime || (now - sendEEGData.lastLogTime) > 5000) {
			console.log('üìä [MONITOR] Enviando EEG v√°lido:', {
				attention: Math.round(ondas.Att),
				relaxation: Math.round(ondas.Med),
				delta: Math.round(ondas.Delta),
				theta: Math.round(ondas.Theta),
				signalQuality: 100
			});
			sendEEGData.lastLogTime = now;
		}

		// Enviar dados no formato esperado pelo backend
		const payload = {
			attention: Math.round(ondas.Att),
			relaxation: Math.round(ondas.Med),
			delta: Math.round(ondas.Delta || 0),
			theta: Math.round(ondas.Theta || 0),
			alpha: Math.round((ondas.LowAlpha + ondas.HighAlpha) / 2 || 0),
			beta: Math.round((ondas.LowBeta + ondas.HighBeta) / 2 || 0),
			gamma: Math.round((ondas.LowGamma + ondas.MiddleGamma) / 2 || 0),
			signalQuality: 100,
			timestamp: new Date().toISOString(),
		};

		socket.emit('eeg:data', payload);
	}
	
	function gerarCodigo() {
		const letras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		let codigo = '5';                          // sempre come√ßa com 5
		
		for (let i = 0; i < 5; i++) {
			codigo += letras.charAt(Math.floor(Math.random() * letras.length));
		}
		
		return codigo;  // Ex: 5KXPVN, 5MYECW, 5HJQRT, etc.
	}
	
	function parseThinkGearPacket(buffer) {
		const view = new Uint8Array(buffer);
		//debugLog.log('Raw bytes:', Array.from(view).map(b => '0x' + b.toString(16).padStart(2, '0')).join(', '));
		let output = '';
		let i = 0;
		while (i < view.length - 2) {
			if (view[i] !== 0xAA || view[i+1] !== 0xAA) {
				debugLog.log(`Sync falhou no √≠ndice ${i}: ${view[i]}, ${view[i+1]}`);
				i++;
				continue;
			}
			const len = view[i+2];
			if (i + len + 4 > view.length) {
				debugLog.log(`Pacote incompleto no √≠ndice ${i}, len: ${len}, buffer: ${view.length}`);
				output += 'Pacote incompleto | ';
				break;
			}
			const payloadStart = i + 3;
			const payloadEnd = i + 3 + len;
			const payload = view.slice(payloadStart, payloadEnd);
			const checksum = view[payloadEnd];
			let sum = 0;
			for (let j = 0; j < len; j++) sum += view[payloadStart + j];
			const calcChecksum = (~sum) & 0xFF;
			//debugLog.log(`Pacote: Sync=0xAA,0xAA, Len=${len}, Payload=[${Array.from(payload).map(b => '0x' + b.toString(16).padStart(2, '0')).join(',')}], Checksum=0x${checksum.toString(16)}, Calc=0x${calcChecksum.toString(16)}`);
			if (checksum === calcChecksum) {
				let j = 0;
				

				while (j < len) {
					const type = payload[j];
					j++;
					if (j >= len) break;

					switch (type) {
						case 0x04: // Attention
							ondas.Att = payload[j] > 99 ? 99 : payload[j]; // garante m√°x 2 d√≠gitos
							// Controle dos LEDs
							if (ondas.Att > 51) {
								light.setAttribute('data-state', 'green');
								label.textContent = 'ATEN√á√ÉO';
							} else if (ondas.Att < 45) {
								light.setAttribute('data-state', 'red');
								label.textContent = 'DESATEN√á√ÉO';
							}
							j++;
							break;

						case 0x05: // Meditation
							ondas.Med = payload[j] > 99 ? 99 : payload[j];
							j++;
							break;

						case 0x83: // Raw EEG Power (bandas)
							const bandLen = payload[j];
							j++;
							if (j + bandLen > len) break;

							const bandOrder = ['Delta', 'Theta', 'LowAlpha', 'HighAlpha', 'LowBeta', 'HighBeta', 'LowGamma', 'MiddleGamma'];

							for (let k = 0; k < 8 && j + 2 < len; k++) {
								const value = (payload[j] | (payload[j+1] << 8) | (payload[j+2] << 16)) >>> 0;
								// Limita a 99 (2 d√≠gitos m√°ximos)
								ondas[bandOrder[k]] = value > 99 ? 99 : value;
								j += 3;
							}
							break;

						// Outros tipos s√£o ignorados silenciosamente para o JSON
					}
				}
			} else {
				output += `Checksum inv√°lido (esperado: ${calcChecksum}, recebido: ${checksum}) | `;
			}
			i += 3 + len + 1;
		}
		return output || 'Nenhum pacote v√°lido encontrado';
	}

	function handleThinkGearStream(event) {
		const buffer = event.target.value.buffer;
		const parsed = parseThinkGearPacket(buffer);
		appendData(parsed);
	}

	async function connectAndDiscover() {
		if (!navigator.bluetooth) {
			alert('‚ùå Web Bluetooth n√£o dispon√≠vel!\n\nVerifique:\n1. Use Chrome, Edge ou Opera\n2. Acesse via HTTPS ou localhost\n3. Bluetooth do PC est√° ligado');
			return updateStatus('Adaptador Bluetooth n√£o encontrado.');
		}

		try {
			updateStatus('Buscando dispositivos... Ative pairing no MindWave (LED piscando).');

			// Tenta primeiro com filtros espec√≠ficos para MindWave
			let requestOptions = {
				filters: [
					{ name: 'MindWave' },
					{ namePrefix: 'Mind' },
					{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] },
					{ services: ['00001101-0000-1000-8000-00805f9b34fb'] }
				],
				optionalServices: [
					'00001101-0000-1000-8000-00805f9b34fb',
					'0000ffe0-0000-1000-8000-00805f9b34fb',
					'0000ffe1-0000-1000-8000-00805f9b34fb',
					'generic_access',
					'battery_service',
					'device_information'
				]
			};

			device = await navigator.bluetooth.requestDevice(requestOptions);
			updateStatus('Conectando ao ' + device.name + '...');
			server = await device.gatt.connect();
			updateStatus('Descobrindo servi√ßos...');
			disconnectBtn.style.display = 'inline-block';
			const services = await server.getPrimaryServices();
			displayUuids(services);
			device.addEventListener('gattserverdisconnected', () => {
				updateStatus('Desconectado. Reconecte o MindWave.');
				disconnectBtn.style.display = 'none';
				resetVars();
			});
		} catch (error) {
			console.error('Erro completo:', error);

			if (error.message.includes('User cancelled')) {
				updateStatus('Pareamento cancelado pelo usu√°rio.');
			} else if (error.message.includes('Connection attempt failed')) {
				// Erro espec√≠fico: dispositivo bloqueado/ocupado
				alert('‚ö†Ô∏è DISPOSITIVO BLOQUEADO!\n\n' +
					'O dispositivo apareceu mas n√£o conseguiu conectar.\n' +
					'Isso acontece quando ele j√° est√° pareado no Windows.\n\n' +
					'SOLU√á√ÉO:\n' +
					'1. Windows ‚Üí Configura√ß√µes ‚Üí Bluetooth\n' +
					'2. REMOVA o dispositivo "=SichirayUSB"\n' +
					'3. DESLIGUE e LIGUE o MindWave novamente\n' +
					'4. Tente conectar APENAS pelo navegador');

				updateStatus('‚ùå REMOVA o dispositivo do Bluetooth do Windows primeiro!\n\n' +
					'O Windows est√° bloqueando a conex√£o. V√° em:\n' +
					'Configura√ß√µes ‚Üí Bluetooth ‚Üí Remover "=SichirayUSB"');
			} else {
				updateStatus(`‚ùå Erro: ${error.message}\n\n‚úÖ Checklist:\n1. MindWave est√° LIGADO?\n2. LED est√° PISCANDO (modo pareamento)?\n3. Bluetooth do PC est√° ATIVO?\n4. J√° pareou no Windows antes? (Configura√ß√µes > Bluetooth)`);
			}
		}
	}

	function resetVars() {
		device = null;
		server = null;
		selectedChar = null;
		characteristics = [];
	}

	async function disconnectBluetooth() {
		if (server) {
			await server.disconnect();
			resetVars();
			disconnectBtn.style.display = 'none';
			updateStatus('Desconectado');
		}
	}
	
		
	function randomChoices(characters, k) {
	  let result = '';
	  for (let i = 0; i < k; i++) {
		const idx = Math.floor(Math.random() * characters.length);
		result += characters[idx];
	  }
	  return result;
	}
	
  </script>
</body>
</html>